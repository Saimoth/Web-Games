<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Calendar</title>
<style>
  :root{
    --bg:#0c0d10; --ink:#e9ecf1; --muted:#9aa3af;
    --accent:#5ab0ff; --card:#151821; --grid:#222736; --today:#1f2a44;
    --dimcell:#0f1118; --dimink:#7c8491;
    --tap:48px; --shadow:0 6px 20px rgba(0,0,0,0.35);
    --day:#10b981; --aa:#ef4444; --ab:#3b82f6;
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f5f7fb; --ink:#0c0d10; --muted:#5c6470; --accent:#2563eb;
      --card:#ffffff; --grid:#e6e9f0; --today:#dfeafe;
      --dimcell:#f0f3f8; --dimink:#8d95a1;
      --shadow:0 6px 16px rgba(0,0,0,0.08);
      --day:#059669; --aa:#dc2626; --ab:#2563eb;
    }
  }

  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;-webkit-tap-highlight-color:transparent}
  .app{display:flex;flex-direction:column;min-height:100vh}

  .toolbar{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;position:sticky;top:0;z-index:10;background:var(--bg);border-bottom:1px solid var(--grid)}
  .toolbar .title{font-weight:700;font-size:18px;text-align:center;flex:1}
  .toolbar .btn{min-width:var(--tap);min-height:var(--tap);display:grid;place-items:center;border-radius:10px;background:var(--card);border:1px solid var(--grid);color:var(--ink);box-shadow:var(--shadow)}
  .toolbar .btn:active{transform:translateY(1px)}
  .toolbar .group{display:flex;gap:8px}

  .month-wrap{padding:10px}
  .page{display:flex; flex-direction:column}

  .dow{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;font-size:12px;color:var(--muted);padding:0 2px 8px}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}

  .cell{
    background:var(--card); border:1px solid var(--grid); border-radius:10px; padding:6px;
    min-height:52px;
    display:flex; flex-direction:column; position:relative; overflow:hidden; cursor:pointer;
  }
  .cell .n{font-weight:600;font-size:14px; position:relative; z-index:1}
  .cell.dim{ background:var(--dimcell) }
  .cell.dim .n{ color:var(--dimink) }
  .cell.today{ outline:2px solid var(--accent); background:var(--today) }

  .shift-bar{position:absolute; left:0; right:0; top:0; height:6px; z-index:2;}
  .shift-day{ background:var(--day); }
  .shift-aa { background:var(--aa); }
  .shift-ab { background:var(--ab); }

  .badge{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    min-width:34px; height:34px;
    display:inline-flex; align-items:center; justify-content:center;
    font-size:16px; font-weight:900; border-radius:999px;
    background:var(--accent); color:#fff; box-shadow:var(--shadow);
    pointer-events:none;
  }

  .note-flag{
    position:absolute; left:6px; right:6px; bottom:4px;
    text-align:center; font-size:11px; color:var(--muted); pointer-events:none;
  }

  .legend{display:flex; gap:14px; justify-content:center; align-items:center; padding:10px 8px; border-top:1px solid var(--grid)}
  .legend .item{display:flex; align-items:center; gap:6px; font-size:13px; color:var(--muted)}
  .legend .dot{width:10px; height:10px; border-radius:999px; display:inline-block}
  .legend .day{background:var(--day)}
  .legend .aa {background:var(--aa)}
  .legend .ab {background:var(--ab)}

  .month-notes{padding:8px 12px 16px; border-top:1px solid var(--grid)}
  .month-notes h4{margin:6px 0 8px 0; font-size:14px; color:var(--muted)}
  .month-notes .note-line{font-size:14px; line-height:1.5}
</style>
</head>
<body>
<div class="app">
  <div class="toolbar">
    <div class="group"><button class="btn" id="prevBtn">⟨</button></div>
    <div class="title" id="title"></div>
    <div class="group">
      <button class="btn" id="todayBtn">Today</button>
      <button class="btn" id="yearBtn">Year</button>
      <button class="btn" id="nextBtn">⟩</button>
    </div>
  </div>

  <div id="monthWrap" class="month-wrap">
    <div id="pageA" class="page"></div>
  </div>

  <div id="legend" class="legend">
    <div class="item"><span class="dot day"></span><span>Day</span></div>
    <div class="item"><span class="dot aa"></span><span>AA Night</span></div>
    <div class="item"><span class="dot ab"></span><span>AB Night</span></div>
  </div>

  <div id="monthNotes" class="month-notes" style="display:none">
    <h4>Notes this month</h4>
    <div id="monthNotesList"></div>
  </div>
</div>

<script>
(function(){
  function loadDB(){try{return JSON.parse(localStorage.getItem("calendarData")||"{}");}catch(e){return {};}}
  const SHIFT_PATTERN=["DAY","DAY","AA","AA","OFF","OFF","DAY","DAY","AB","AB","OFF","OFF"];
  const ANCHOR=new Date("2025-08-14T00:00:00Z");
  function startUTC(d){return Date.UTC(d.getFullYear(),d.getMonth(),d.getDate());}
  function shiftIndexFor(date){const diffDays=Math.floor((startUTC(date)-startUTC(ANCHOR))/86400000);return ((diffDays%12)+12)%12;}
  function shiftCodeFor(date){return SHIFT_PATTERN[shiftIndexFor(date)];}
  function shiftClass(code){if(code==="DAY")return"shift-day";if(code==="AA")return"shift-aa";if(code==="AB")return"shift-ab";return"";}

  const monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"];
  const dowNames=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

  const params=new URLSearchParams(location.search);
  const today=new Date();
  let viewYear = parseInt(params.get("year")||today.getFullYear(),10);
  let viewMonth = (parseInt(params.get("month")|| (today.getMonth()+1),10) - 1);
  if(isNaN(viewYear)) viewYear=today.getFullYear();
  if(isNaN(viewMonth)||viewMonth<0||viewMonth>11) viewMonth=today.getMonth();

  const $=s=>document.querySelector(s);
  const pageA=$("#pageA");

  function sameDay(a,b){return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate();}
  function keyFromDate(x){return `${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,"0")}-${String(x.getDate()).padStart(2,"0")}`;}
  function ordinal(n){const s=["th","st","nd","rd"],v=n%100;return n+(s[(v-20)%10]||s[v]||s[0]);}
  function escapeHTML(s){return s.replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]));}

  function buildMonth(year,month){
    const db=loadDB();
    const first=new Date(year,month,1);
    const startDow=(first.getDay()+6)%7;
    const daysInMonth=new Date(year,month+1,0).getDate();
    const prevMonthDays=new Date(year,month,0).getDate();

    const frag=document.createDocumentFragment();

    const dow=document.createElement("div");
    dow.className="dow";
    for(const n of dowNames){const d=document.createElement("div");d.textContent=n;dow.appendChild(d);}
    frag.appendChild(dow);

    const grid=document.createElement("div");grid.className="grid";
    const total=42;
    for(let i=0;i<total;i++){
      const dayNum=i-startDow+1;
      let d,dim=false;
      if(dayNum<1){dim=true;d=new Date(year,month-1,prevMonthDays+dayNum);}
      else if(dayNum>daysInMonth){dim=true;d=new Date(year,month+1,dayNum-daysInMonth);}
      else{d=new Date(year,month,dayNum);}
      const cell=document.createElement("div");cell.className="cell"+(dim?" dim":"");
      if(sameDay(d,today))cell.classList.add("today");

      const code=shiftCodeFor(d),cls=shiftClass(code);
      if(cls){const sb=document.createElement("div");sb.className=`shift-bar ${cls}`;cell.appendChild(sb);}

      const nEl=document.createElement("div");nEl.className="n";nEl.textContent=d.getDate();cell.appendChild(nEl);

      const k=keyFromDate(d),count=(db[k]&&Array.isArray(db[k].entries))?db[k].entries.length:0;
      if(count>0){const badge=document.createElement("div");badge.className="badge";badge.textContent=count;cell.appendChild(badge);}

      const hasNote=db[k]&&typeof db[k].notes==="string"&&db[k].notes.trim().length>0;
      if(hasNote){const nf=document.createElement("div");nf.className="note-flag";nf.textContent="Note";cell.appendChild(nf);}

      cell.addEventListener("click",()=>{const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,"0"),day=String(d.getDate()).padStart(2,"0");window.location.href=`calendarDay.html?date=${y}-${m}-${day}`;});
      grid.appendChild(cell);
    }
    frag.appendChild(grid);
    return frag;
  }

  function renderMonthNotes(year,month){
    const db=loadDB(),items=[];
    for(const [k,val] of Object.entries(db)){
      if(!val||typeof val.notes!=="string")continue;
      const [yy,mm,dd]=k.split("-").map(n=>parseInt(n,10));
      if(yy===year&&(mm-1)===month){
        const note=val.notes.trim();
        if(note)items.push({day:dd,text:note});
      }
    }
    items.sort((a,b)=>a.day-b.day);
    const monthNotes=$("#monthNotes"),monthNotesList=$("#monthNotesList");
    if(items.length===0){monthNotes.style.display="none";monthNotesList.innerHTML="";return;}
    monthNotes.style.display="block";
    monthNotesList.innerHTML=items.map(it=>`<div class="note-line">${ordinal(it.day)}: ${escapeHTML(it.text)}</div>`).join("");
  }

  function render(){
    pageA.innerHTML="";
    pageA.appendChild(buildMonth(viewYear,viewMonth));
    $("#title").textContent=`${monthNames[viewMonth]} ${viewYear}`;
    renderMonthNotes(viewYear,viewMonth);
  }

  $("#prevBtn").onclick=()=>{viewMonth--;if(viewMonth<0){viewMonth=11;viewYear--;}render();}
  $("#nextBtn").onclick=()=>{viewMonth++;if(viewMonth>11){viewMonth=0;viewYear++;}render();}
  $("#todayBtn").onclick=()=>{const t=new Date();viewYear=t.getFullYear();viewMonth=t.getMonth();render();}
  $("#yearBtn").onclick=()=>{window.location.href=`calendarYear.html?year=${viewYear}&month=${String(viewMonth+1).padStart(2,"0")}`;}

  render();
  window.addEventListener("storage", render);
})();
</script>
</body>
</html>