<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Xstitch</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 1.5rem;
      background: #fafafa;
      color: #333;
    }
    h1 {
      margin-bottom: 0.5rem;
    }
    #controls {
      margin-bottom: 1rem;
    }
    label {
      margin: 0 0.5rem;
      font-size: 1rem;
    }
    select, button {
      padding: 0.4rem 0.8rem;
      font-size: 1rem;
      margin-left: 0.3rem;
    }
    #info {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: #555;
    }
    #output {
      margin: 1rem auto;
      padding: 1rem;
      max-width: 90vw;
      background: #fff;
      border: 1px solid #ddd;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    #output canvas {
      width: 100%;
      height: auto;
      image-rendering: pixelated;
      display: block;
      margin: 0 auto;
    }
  </style>
</head>
<body>

  <h1>Xstitch</h1>

  <div id="controls">
    <label>
      Scale:
      <select id="sizeSelect">
        <option value="32">32</option>
        <option value="64">64</option>
        <option value="128" selected>128</option>
      </select>
    </label>
    <label>
      Palette:
      <select id="paletteSelect">
        <option>Standard</option>
        <option>Cool</option>
        <option>Warm</option>
        <option>Summer</option>
        <option>Winter</option>
        <option>Autumn</option>
        <option>Spring</option>
        <option>Vibrant</option>
      </select>
    </label>
    <button id="uploadBtn">Upload Photo</button>
    <input type="file" id="fileInput" accept="image/*" style="display:none">
  </div>

  <div id="info"></div>
  <div id="output"></div>

  <script>
    // 32-colour palettes
    const palettes = {
      Standard: [
        "#000000","#FFFFFF","#555555","#AAAAAA","#333333","#CCCCCC",
        "#FF0000","#00FF00","#0000FF","#FFFF00","#FF00FF","#00FFFF",
        "#800000","#008000","#000080","#808000","#800080","#008080",
        "#FFA500","#A52A2A","#228B22","#DAA520","#2E8B57","#6B8E23",
        "#800020","#406080","#608040","#804060","#408060","#604080"
      ],
      Cool: [
        "#000000","#FFFFFF","#001F3F","#003F7F","#005FBF","#007FFF",
        "#009FFF","#00BFFF","#00FFFF","#1FFFFF","#3FFFFF","#5FFFFF",
        "#7FFFFF","#9FFFFF","#005F5F","#007F7F","#009F9F","#00BFBF",
        "#00DFDF","#00FFFF","#1FDFFF","#3FDFFF","#5FDFFF","#7FDFFF",
        "#9FDFFF","#BFDFFF","#007080","#0090A0","#00A0B0","#00B0C0",
        "#00C0D0","#00D0E0"
      ],
      Warm: [
        "#000000","#FFFFFF","#7F0000","#9F0000","#BF0000","#DF0000",
        "#FF0000","#FF1F00","#FF3F00","#FF5F00","#FF7F00","#FF9F00",
        "#FFBF00","#FFDF00","#FFFF00","#FFFF1F","#FFFF3F","#FFFF5F",
        "#FFFF7F","#FFFF9F","#FFCC66","#FFAA33","#FF8822","#FF6611",
        "#FF4422","#FF2200","#CC3300","#AA5500","#886600","#664400",
        "#442200","#220000"
      ],
      Summer: [
        "#000000","#FFFFFF","#FFCCCC","#FF99CC","#FF66CC","#FF33CC",
        "#FF00CC","#CC00AA","#CC3399","#CC6699","#CC99CC","#99CCFF",
        "#66CCFF","#33CCFF","#00CCFF","#00CC99","#33CC66","#66CC33",
        "#99CC00","#CCCC33","#FFD699","#FFC366","#FFB033","#FF9F00",
        "#CC7A00","#995500","#663300","#332200","#FFB6C1","#FFAEB9",
        "#FF9FBF","#FF90C5"
      ],
      Winter: [
        "#000000","#FFFFFF","#E6F0FF","#CCE0FF","#B3D1FF","#99C1FF",
        "#80B2FF","#66A3FF","#4D94FF","#3385FF","#1A75FF","#0066FF",
        "#005CE6","#0052CC","#0047B3","#003D99","#003380","#002A66",
        "#00204D","#001533","#004466","#006688","#0088AA","#00AACC",
        "#00CCEE","#1AD5FF","#33DEFF","#4DE7FF","#66F0FF","#80F9FF",
        "#99FFFF","#B3FFFF"
      ],
      Autumn: [
        "#000000","#FFFFFF","#662200","#773300","#884400","#995500",
        "#AA6600","#BB7700","#CC8800","#DD9900","#EEAA00","#FFBB00",
        "#FFCC33","#FF9933","#FF6633","#FF3333","#CC0033","#990033",
        "#660033","#330019","#663300","#7F4422","#997744","#B38B6B",
        "#CCAA99","#FFD9B3","#FFCC99","#FFB380","#FF9966","#FF8040",
        "#FF6633","#FF4C1A"
      ],
      Spring: [
        "#000000","#FFFFFF","#CCFFCC","#99FF99","#66FF66","#33FF33",
        "#00FF00","#00CC00","#33CC66","#66CC99","#99CCCC","#CCFFEE",
        "#99FFDD","#66FFCC","#33FFBB","#00FFAA","#00CC88","#00AA66",
        "#008844","#006622","#004400","#002200","#FFCCCC","#FF9999",
        "#FF6666","#FF3333","#FF0000","#CC0000","#990000","#660000",
        "#330000","#660033"
      ],
      Vibrant: [
        "#000000","#FFFFFF","#FF0000","#FF7F00","#FFFF00","#7FFF00",
        "#00FF00","#00FF7F","#00FFFF","#007FFF","#0000FF","#7F00FF",
        "#FF00FF","#FF0099","#FF0066","#FF0033","#FF0019","#FF3366",
        "#FF6699","#FF99CC","#CC33FF","#9933FF","#6633FF","#3333FF",
        "#3366FF","#3399FF","#33CCFF","#33FFFF","#33FFCC","#33FF99",
        "#33FF66","#33FF33"
      ]
    };

    // helpers
    function hexToRgb(hex) {
      hex = hex.replace(/^#/, '');
      if (hex.length === 3) hex = hex.split('').map(c=>c+c).join('');
      const val = parseInt(hex, 16);
      return [(val >> 16) & 255, (val >> 8) & 255, val & 255];
    }
    function findTwoNearest(palette, r, g, b) {
      let best1 = 0, best2 = 1, dist1 = Infinity, dist2 = Infinity;
      palette.forEach((c, i) => {
        const dr = r - c[0], dg = g - c[1], db = b - c[2];
        const d = dr*dr + dg*dg + db*db;
        if (d < dist1) {
          dist2 = dist1; best2 = best1;
          dist1 = d;    best1 = i;
        } else if (d < dist2) {
          dist2 = d;    best2 = i;
        }
      });
      return [ palette[best1], palette[best2] ];
    }

    // DOM refs & state
    const uploadBtn     = document.getElementById('uploadBtn');
    const fileInput     = document.getElementById('fileInput');
    const sizeSelect    = document.getElementById('sizeSelect');
    const paletteSelect = document.getElementById('paletteSelect');
    const info          = document.getElementById('info');
    const output        = document.getElementById('output');

    let origPixels = null, origW = 0, origH = 0;

    // redraw with current settings
    function redraw() {
      if (!origPixels) return;
      const maxSide = parseInt(sizeSelect.value, 10);
      const scaledW = origW >= origH
        ? maxSide
        : Math.round(maxSide * origW / origH);
      const scaledH = origH > origW
        ? maxSide
        : Math.round(maxSide * origH / origW);

      const paletteRGB = palettes[paletteSelect.value].map(hexToRgb);
      info.textContent = 
        `Orig: ${origW}×${origH}px → ${scaledW}×${scaledH}px using “${paletteSelect.value}”`;

      // error buffers
      const errR = Array(scaledH).fill().map(()=>Array(scaledW).fill(0));
      const errG = Array(scaledH).fill().map(()=>Array(scaledW).fill(0));
      const errB = Array(scaledH).fill().map(()=>Array(scaledW).fill(0));

      const blockSize = 8;
      const canvasOut = document.createElement('canvas');
      canvasOut.width  = scaledW * blockSize;
      canvasOut.height = scaledH * blockSize;
      const ctx = canvasOut.getContext('2d');
      canvasOut.style.imageRendering = 'pixelated';

      const bw = origW / scaledW;
      const bh = origH / scaledH;

      for (let y = 0; y < scaledH; y++) {
        for (let x = 0; x < scaledW; x++) {
          // average block
          const x0 = Math.floor(x * bw),
                y0 = Math.floor(y * bh),
                x1 = Math.min(origW, Math.floor((x + 1) * bw)),
                y1 = Math.min(origH, Math.floor((y + 1) * bh));
          let r=0, g=0, b=0, count=0;
          for (let yy = y0; yy < y1; yy++) {
            for (let xx = x0; xx < x1; xx++) {
              const i = (yy * origW + xx) * 4;
              r += origPixels[i];
              g += origPixels[i+1];
              b += origPixels[i+2];
              count++;
            }
          }
          r = (count ? r/count : 0) + errR[y][x];
          g = (count ? g/count : 0) + errG[y][x];
          b = (count ? b/count : 0) + errB[y][x];
          [r,g,b] = [r,g,b].map(v => Math.max(0, Math.min(255, v)));

          // find colours
          const [prim, sec] = findTwoNearest(paletteRGB, r, g, b);
          const [pr,pg,pb] = prim, [sr,sg,sb] = sec;

          // diffuse error
          const er = r - pr, eg = g - pg, eb = b - pb;
          [[1,0,7/16],[-1,1,3/16],[0,1,5/16],[1,1,1/16]].forEach(([dx,dy,f])=>{
            const xx = x + dx, yy = y + dy;
            if (xx >= 0 && xx < scaledW && yy >= 0 && yy < scaledH) {
              errR[yy][xx] += er * f;
              errG[yy][xx] += eg * f;
              errB[yy][xx] += eb * f;
            }
          });

          // draw block & stitch
          const px = x * blockSize, py = y * blockSize;
          ctx.fillStyle   = `rgb(${pr},${pg},${pb})`;
          ctx.fillRect(px, py, blockSize, blockSize);
          ctx.strokeStyle = `rgb(${sr},${sg},${sb})`;
          ctx.lineWidth   = 1;
          ctx.beginPath();
          if ((x + y) % 2 === 0) {
            ctx.moveTo(px, py + blockSize);
            ctx.lineTo(px + blockSize, py);
          } else {
            ctx.moveTo(px, py);
            ctx.lineTo(px + blockSize, py + blockSize);
            ctx.moveTo(px, py + blockSize);
            ctx.lineTo(px + blockSize, py);
          }
          ctx.stroke();
        }
      }

      output.innerHTML = '';
      output.appendChild(canvasOut);
    }

    // events
    [paletteSelect, sizeSelect].forEach(el => 
      el.addEventListener('change', redraw)
    );

    uploadBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file || !file.type.startsWith('image/')) {
        return alert('Please select an image file.');
      }
      const reader = new FileReader();
      reader.onload = ev => {
        const img = new Image();
        img.onload = () => {
          origW = img.naturalWidth;
          origH = img.naturalHeight;
          const tempC = document.createElement('canvas');
          tempC.width = origW; tempC.height = origH;
          const tempCtx = tempC.getContext('2d');
          tempCtx.drawImage(img, 0, 0);
          origPixels = tempCtx.getImageData(0, 0, origW, origH).data;
          redraw();
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });
  </script>

</body>
</html>