<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mortgage & Pension Calculator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; margin: 10px; background: #fafcff; }
        .tabs { display: flex; cursor: pointer; }
        .tab { flex:1; padding: 16px 0; text-align: center; font-size: 1.3em; border: 2px solid #0072c6; border-bottom: none; background: #e6f1fb; }
        .tab.active { background: #fff; font-weight: bold; color: #0072c6; }
        .tab-content { border: 2px solid #0072c6; border-top: none; padding: 22px; background: #fff; border-radius: 0 0 8px 8px; }

        .form-group {
            display: flex;
            align-items: center;
            margin-bottom: 18px;
            font-size: 1.1em;
            flex-wrap: nowrap;
        }
        .form-group label {
            min-width: 130px;
            margin-right: 8px;
            margin-bottom: 0;
            white-space: nowrap;
        }
        .form-group input[type="number"], 
        .form-group input[type="text"] {
            width: 90px;
            margin-right: 5px;
            margin-bottom: 0;
            padding: 10px;
            font-size: 1.06em;
            border-radius: 6px;
            border: 1.5px solid #b0c8e0;
        }
        .years-months {
            width: 45px !important;
        }
        .form-group input[type="checkbox"] { width: 20px; height: 20px; margin-right: 6px; }
        .unit {
            margin-left: 2px;
            margin-right: 20px;
            white-space: nowrap;
            font-size: 0.98em;
            color: #456;
        }
        .stacked-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .stacked-input-row, .repayment-input-row {
            margin-left: 27px;
            margin-top: 5px;
            display: flex;
            align-items: center;
        }
        button {
            padding: 14px 0; font-size: 1.15em; width: 100%;
            background: #0072c6; color: #fff; border: none; border-radius: 7px; font-weight: bold; margin-top: 10px;
        }
        #results-section { margin-top: 30px; }
        #monthly-payment { font-size:1.13em; margin-bottom: 18px; }
        #chart-container { width: 100%; max-width: 99vw; height: 250px; margin: 0 auto 30px auto; }
        #log { background: #f7fafd; border: 1.5px solid #cce1f7; border-radius: 8px; max-height: 190px; overflow-y: auto; padding: 18px; font-size: 0.97em; }
        @media (max-width: 600px) {
            .tab, button { font-size: 1em; }
            .tab-content, #log { padding: 10px; }
            #chart-container { height: 170px; }
            .form-group { flex-wrap: wrap; font-size: 1em;}
            .form-group label, .form-group .unit { min-width: unset; margin-bottom: 4px; }
            .stacked-input-row, .repayment-input-row { margin-left: 0; }
        }
    </style>
</head>
<body>

<div class="tabs">
    <div class="tab active" onclick="showTab('mortgage')">Mortgage</div>
    <div class="tab" onclick="showTab('pension')">Pension</div>
</div>

<div class="tab-content" id="mortgage-tab">
    <h2 style="font-size:1.5em;">Mortgage Calculator</h2>
    <div class="form-group">
        <label for="mortgage-amount">£ Borrowed:</label>
        <input type="number" id="mortgage-amount" value="250000" min="0" step="1000">
        <span class="unit">pounds</span>
    </div>
    <div class="form-group">
        <label for="mortgage-rate">Interest Rate:</label>
        <input type="number" id="mortgage-rate" value="4" min="0" step="0.01">
        <span class="unit">% per year</span>
    </div>
    <div class="form-group" style="flex-direction: column; align-items: flex-start;">
        <label for="mortgage-years" style="min-width:unset;">Repayment Period:</label>
        <div class="repayment-input-row">
            <input type="number" class="years-months" id="mortgage-years" value="25" min="0" step="1">
            <span class="unit">years</span>
            <input type="number" class="years-months" id="mortgage-months" value="0" min="0" max="11" step="1">
            <span class="unit">months</span>
        </div>
    </div>
    <div class="form-group stacked-group">
        <div>
            <input type="checkbox" id="overpayment-check" onchange="toggleOverpayment()">
            <label for="overpayment-check" style="margin-right:8px;">Include Overpayment?</label>
        </div>
        <div class="stacked-input-row">
            <input type="number" id="overpayment-amount" value="200" min="0" step="10" disabled>
            <span class="unit">per month</span>
        </div>
    </div>
    <div class="form-group stacked-group">
        <div>
            <input type="checkbox" id="payrise-check" onchange="togglePayrise()">
            <label for="payrise-check" style="margin-right:8px;">Include Payrise?</label>
        </div>
        <div class="stacked-input-row">
            <input type="number" id="payrise-percent" value="3" min="0" max="100" step="0.1" disabled>
            <span class="unit">% per year</span>
        </div>
    </div>
    <button onclick="calculateMortgage()">Calculate</button>
    <div id="results-section" style="display:none;">
        <div id="summary" style="font-size:1.13em; margin-bottom:12px;"></div>
        <div id="monthly-payment"></div>
        <div id="chart-container">
            <canvas id="mortgage-chart"></canvas>
        </div>
        <div>
            <strong>Repayment Log (every 3 months):</strong>
            <div id="log"></div>
        </div>
    </div>
</div>

<div class="tab-content" id="pension-tab" style="display:none;">
    <h2 style="font-size:1.5em;">Pension Calculator</h2>
    <p style="font-size:1.1em;">Pension calculator coming soon!</p>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function showTab(tabName) {
    document.getElementById('mortgage-tab').style.display = (tabName === 'mortgage') ? '' : 'none';
    document.getElementById('pension-tab').style.display = (tabName === 'pension') ? '' : 'none';
    var tabs = document.getElementsByClassName('tab');
    for(let i=0; i<tabs.length; i++) tabs[i].classList.remove('active');
    if(tabName === 'mortgage') tabs[0].classList.add('active');
    else tabs[1].classList.add('active');
}
function toggleOverpayment() {
    var check = document.getElementById('overpayment-check');
    var input = document.getElementById('overpayment-amount');
    input.disabled = !check.checked;
}
function togglePayrise() {
    var check = document.getElementById('payrise-check');
    var input = document.getElementById('payrise-percent');
    input.disabled = !check.checked;
}

function calculateMortgage() {
    // Fetch input values
    const principal = parseFloat(document.getElementById('mortgage-amount').value);
    const annualRate = parseFloat(document.getElementById('mortgage-rate').value) / 100;
    const years = parseInt(document.getElementById('mortgage-years').value);
    const months = parseInt(document.getElementById('mortgage-months').value);
    const periodMonths = years * 12 + months;
    const overpayChecked = document.getElementById('overpayment-check').checked;
    const payriseChecked = document.getElementById('payrise-check').checked;
    let overpay = overpayChecked ? parseFloat(document.getElementById('overpayment-amount').value) : 0;
    let payrise = payriseChecked ? parseFloat(document.getElementById('payrise-percent').value) : 0;

    // Monthly interest rate
    const monthlyRate = annualRate / 12;

    // Calculate the base monthly payment
    let baseMonthlyPayment = (monthlyRate === 0)
        ? (principal / periodMonths)
        : (principal * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -periodMonths));

    let currentMonthlyPayment = baseMonthlyPayment;
    let currentOverpay = overpayChecked ? overpay : 0;

    const initialTotalPayment = currentMonthlyPayment + currentOverpay; // initial payment, month 1

    // Variables for simulation
    let balance = principal, totalPaid = 0, totalInterest = 0;
    let log = [], chartData = [], labels = [];
    let month = 0;
    let finalPayment = initialTotalPayment;

    // For graph & log, record every 3 months
    while (balance > 0.01 && month < 1000 * 12) {
        // Increase both monthly repayment and overpayment every 12 months if payrise enabled
        if (payriseChecked && month > 0 && month % 12 === 0) {
            currentMonthlyPayment += currentMonthlyPayment * (payrise / 100);
            currentOverpay += currentOverpay * (payrise / 100);
        }

        let payment = Math.min(currentMonthlyPayment + currentOverpay, balance + balance * monthlyRate);

        // Track the largest payment (the last/cumulative payment with all rises)
        if (payment > finalPayment) finalPayment = payment;

        let interest = balance * monthlyRate;
        let principalPaid = payment - interest;
        if (principalPaid > balance) principalPaid = balance;

        balance -= principalPaid;
        totalPaid += payment;
        totalInterest += interest;

        chartData.push(balance < 0 ? 0 : balance);
        labels.push('Month ' + (month + 1));

        if (month % 3 === 0 || balance < 0.01) {
            log.push(`Month ${month+1}: Balance £${balance.toFixed(2)}, Payment £${payment.toFixed(2)}, Paid £${totalPaid.toFixed(2)}, Interest £${totalInterest.toFixed(2)}`);
        }

        month++;
    }

    // Show payments and summary
    let monthlyHtml = `
        <b>Initial Monthly Repayment (inc. overpayment):</b> £${initialTotalPayment.toLocaleString(undefined, {maximumFractionDigits:2})}<br>
        <b>Final Monthly Repayment (inc. overpayment and payrises):</b> £${finalPayment.toLocaleString(undefined, {maximumFractionDigits:2})}
    `;
    document.getElementById('monthly-payment').innerHTML = monthlyHtml;

    let summary = `
        <b>Total months to repay:</b> ${month} <br>
        <b>Total years:</b> ${(month/12).toFixed(2)} <br>
        <b>Total paid:</b> £${totalPaid.toLocaleString(undefined,{maximumFractionDigits:2})} <br>
        <b>Total interest paid:</b> £${totalInterest.toLocaleString(undefined,{maximumFractionDigits:2})}
    `;
    document.getElementById('summary').innerHTML = summary;
    document.getElementById('results-section').style.display = '';
    document.getElementById('log').innerHTML = log.join('<br>');

    // Plot chart with YEARS on the x-axis (2 yearly ticks if more than 15 years)
    if(window.mortgageChartObj) window.mortgageChartObj.destroy();
    const ctx = document.getElementById('mortgage-chart').getContext('2d');
    const totalYears = Math.ceil(periodMonths / 12);
    window.mortgageChartObj = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Outstanding Balance (£)',
                data: chartData,
                borderWidth: 3,
                fill: false,
                pointRadius: 0
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, title: { display:true, text:'Balance (£)' } },
                x: { 
                    title: { display: true, text: 'Years' },
                    grid: {
                        drawOnChartArea: true,
                        color: function(context) {
                            // Only draw grid line every 12th index (every year)
                            if (context.tick && context.tick.value % 12 === 0) {
                                return '#bbb';
                            }
                            return 'transparent';
                        }
                    },
                    ticks: {
                        stepSize: 12, // Always mark grid/tick every 12 months
                        callback: function(value, index, values) {
                            // If loan is more than 15 years, show label every 2 years, else every year
                            if (totalYears > 15) {
                                if (index % 24 === 0) return (index / 12);
                            } else {
                                if (index % 12 === 0) return (index / 12);
                            }
                            return '';
                        },
                        autoSkip: false,
                        maxRotation: 0,
                        minRotation: 0
                    }
                }
            }
        }
    });
}
toggleOverpayment();
togglePayrise();
</script>
</body>
</html>