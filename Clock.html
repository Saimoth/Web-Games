<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Minute-Hand Trainer</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100vh;
      touch-action: manipulation;
      user-select: none;
      font-family: sans-serif;
      background: #fafafa;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }
    body {
      display: grid;
      grid-template-rows: 2fr auto 2fr;
      justify-items: center;
      overflow: hidden;
    }
    #prompt {
      grid-row: 1;
      align-self: end;
      font-size: 2.5em;
      text-align: center;
      margin: 0 20px 20px;
    }
    #clock-container {
      grid-row: 2;
      align-self: center;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
    }
    #clock-face {
      position: relative;
      width: 80vmin;
      height: 80vmin;
      max-width: 90vw;
      max-height: 90vw;
      border: 5px solid #333;
      border-radius: 50%;
      background: #fff;
      touch-action: none;
    }

    /* Widened hit-area: now 60px, centered via -30px */
    .hand {
      position: absolute;
      bottom: 50%;
      left: 50%;
      width: 60px;           /* ↑ easier to grab */
      margin-left: -30px;     /* center the hit-area */
      height: 40%;
      transform-origin: bottom center;
      cursor: pointer;
      touch-action: none;
    }
    .hand::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      width: 6px;
      height: 100%;
    }

    #center-dot {
      position: absolute;
      width: 14px;
      height: 14px;
      background: #333;
      border-radius: 50%;
      top: 50%;
      left: 50%;
      margin: -7px 0 0 -7px;
      pointer-events: none;
      z-index: 3;
    }
    .number {
      position: absolute;
      user-select: none;
      pointer-events: none;
      font-size: 1.2em;
    }
    #check-btn {
      grid-row: 3;
      align-self: start;
      font-size: 1.8em;
      padding: 20px 60px;
      margin: 20px 0 0;
    }
    #fireworks-canvas {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      pointer-events: none;
      display: none;
      z-index: 999;
    }
  </style>
</head>
<body>
  <div id="prompt">Loading…</div>

  <div id="clock-container">
    <div id="clock-face">
      <div id="minute-hand" class="hand" data-angle="0"></div>
      <div id="center-dot"></div>
    </div>
  </div>

  <button id="check-btn">Check</button>

  <!-- Notification sound -->
  <audio id="online"
         src="https://www.orangefreesounds.com/wp-content/uploads/2016/12/Short-ringtone-for-notification.mp3"
         preload="auto"></audio>

  <canvas id="fireworks-canvas"></canvas>

  <script>
    function getPointer(e) {
      if (e.touches && e.touches[0]) {
        return { x: e.touches[0].clientX, y: e.touches[0].clientY };
      }
      return { x: e.clientX, y: e.clientY };
    }
    function angleDiff(a, b) {
      let d = ((a - b + 540) % 360) - 180;
      return Math.abs(d);
    }

    const minuteLabels = {
      0:  "O'Clock",   5:  "Five Past",    10: "Ten Past",
      15: "Quarter Past", 20: "Twenty Past", 25: "Twenty-Five Past",
      30: "Half Past", 35: "Twenty-Five To", 40: "Twenty To",
      45: "Quarter To", 50: "Ten To",      55: "Five To"
    };
    const minuteKeys = [0,5,10,15,20,25,30,35,40,45,50,55];

    function drawNumbers() {
      const face = document.getElementById('clock-face');
      face.querySelectorAll('.number').forEach(n => n.remove());
      const r = face.clientWidth / 2;
      const offset = r * 0.85;
      for (let i = 1; i <= 12; i++) {
        const ang = (i * 30) * Math.PI/180;
        const x = r + offset * Math.sin(ang);
        const y = r - offset * Math.cos(ang);
        const el = document.createElement('div');
        el.className = 'number';
        el.textContent = i;
        el.style.left = x + 'px';
        el.style.top  = y + 'px';
        el.style.transform = 'translate(-50%, -50%)';
        face.appendChild(el);
      }
    }

    let targetM;
    const promptEl   = document.getElementById('prompt');
    const clockFace  = document.getElementById('clock-face');
    const minuteHand = document.getElementById('minute-hand');
    const audioBell  = document.getElementById('online');

    function setHand(el, angle) {
      el.dataset.angle   = angle;
      el.style.transform = 'rotate(' + angle + 'deg)';
    }

    function newQuestion() {
      targetM = minuteKeys[Math.floor(Math.random() * minuteKeys.length)];
      promptEl.textContent = minuteLabels[targetM];
      setHand(minuteHand, 0);
    }

    let dragging = false;
    function startDrag(e) {
      if (e.target === minuteHand) {
        dragging = true;
        e.preventDefault();
      }
    }
    function onDrag(e) {
      if (!dragging) return;
      const p    = getPointer(e);
      const rect = clockFace.getBoundingClientRect();
      const cx   = rect.left + rect.width/2;
      const cy   = rect.top  + rect.height/2;
      const dx   = p.x - cx, dy = p.y - cy;
      const raw  = Math.atan2(dx, -dy) * 180/Math.PI;
      const snap = Math.round(raw / 30) * 30;
      setHand(minuteHand, snap);
      e.preventDefault();
    }
    function endDrag() { dragging = false; }

    clockFace.addEventListener('mousedown',  startDrag);
    clockFace.addEventListener('touchstart', startDrag);
    document.addEventListener('mousemove',  onDrag);
    document.addEventListener('touchmove',  onDrag, { passive:false });
    document.addEventListener('mouseup',    endDrag);
    document.addEventListener('touchend',   endDrag);

    const canvas = document.getElementById('fireworks-canvas');
    const ctx    = canvas.getContext('2d');
    function rand(min,max){ return min + Math.random()*(max-min); }
    function randColor(){ return `hsl(${Math.random()*360},100%,50%)`; }

    function launchFireworks() {
      canvas.width  = window.innerWidth;
      canvas.height = window.innerHeight;
      canvas.style.display = 'block';
      const rect = clockFace.getBoundingClientRect();
      const sx = rect.left + rect.width/2;
      const sy = rect.top  + rect.height/2;
      const parts = [];
      for (let i = 0; i < 80; i++){
        parts.push({ x: sx, y: sy, vx: rand(-4,4), vy: rand(-7,-2), life: 1800, col: randColor() });
      }
      const start = performance.now();
      function frame(now) {
        const t = now - start;
        ctx.clearRect(0,0,canvas.width,canvas.height);
        parts.forEach(p => {
          const f = t / p.life;
          if (f > 1) return;
          p.x += p.vx; p.y += p.vy; p.vy += 0.1;
          ctx.globalAlpha = 1 - f;
          ctx.fillStyle   = p.col;
          ctx.beginPath();
          ctx.arc(p.x,p.y,3,0,2*Math.PI);
          ctx.fill();
        });
        if (t < 1800) requestAnimationFrame(frame);
        else {
          ctx.clearRect(0,0,canvas.width,canvas.height);
          canvas.style.display = 'none';
          newQuestion();
        }
      }
      requestAnimationFrame(frame);
    }

    document.getElementById('check-btn').addEventListener('click', () => {
      const mAng    = parseFloat(minuteHand.dataset.angle) || 0;
      const expectA = targetM * 6;
      if (angleDiff(mAng, expectA) < 1) {
        audioBell.currentTime = 0;
        audioBell.play().catch(() => {});
        launchFireworks();
      } else {
        alert("Not quite—try again!");
      }
    });

    window.addEventListener('load', () => {
      drawNumbers();
      newQuestion();
    });
    window.addEventListener('resize', () => {
      drawNumbers();
      if (canvas.style.display === 'block') {
        canvas.width  = window.innerWidth;
        canvas.height = window.innerHeight;
      }
    });
  </script>
</body>
</html>